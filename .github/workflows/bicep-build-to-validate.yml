name: Bicep Build Test

on:
  pull_request:
    branches:
      - main
    paths:
      - "**.bicep"
  workflow_dispatch: {}

jobs:
  bicep_unit_tests:
    name: Test Bicep Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Bicep Build to Test
        shell: pwsh
        run: |
          Get-ChildItem -Recurse -Filter '*.bicep' | ForEach-Object {
              Write-Information "==> Attempting Bicep Build For File: $_" -InformationAction Continue
              bicep build $_.FullName
          }

      - name: ARM-TTK Bicep Parameter Files
        uses: github/super-linter@v4
        env:
          VALIDATE_ALL_CODEBASE: true
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FILTER_REGEX_EXCLUDE: .*infra-as-code/bicep/modules/policy/definitions/lib/.*
          VALIDATE_ARM: true
          VALIDATE_JSON: true

  bicep_deploy:
    name: Deploy Bicep Files
    runs-on: ubuntu-latest
    env:
      ResourceGroupName: gitaction-bicep-rg
      ResourceGroupLocation: "EastUS"
    environment: testdeploy

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.ALZ_AZURE_SECRET }}
          enable-AzPSSession: true
      
      - name: Az CLI Create Resource Group
        uses: Azure/CLI@v1
        with: 
          inlineScript: |
            #!/bin/bash
            az group create --name ${{ env.ResourceGroupName }} --location ${{ env.ResourceGroupLocation }}
      
      - name: Az CLI Deploy managementGroups
        uses: Azure/CLI@v1
        with: 
          inlineScript: |   
            az deployment tenant create --template-file infra-as-code/bicep/modules/managementGroups/managementGroups.bicep --parameters @infra-as-code/bicep/modules/managementGroups/managementGroups.parameters.example.json --location eastus

      - name: Az CLI Deploy Custom Role Definitions
        uses: Azure/CLI@v1
        with: 
          inlineScript: |   
            az deployment mg create --template-file infra-as-code/bicep/modules/customRoleDefinitions/customRoleDefinitions.bicep  --parameters @infra-as-code/bicep/modules/customRoleDefinitions/customRoleDefinitions.parameters.example.json --location eastus --management-group-id alz

      - name: Az CLI Deploy Custom Policy Definitions
        uses: Azure/CLI@v1
        with: 
          inlineScript: |   
            az deployment mg create --template-file infra-as-code/bicep/modules/policy/definitions/custom-policy-definitions.bicep  --parameters @infra-as-code/bicep/modules/policy/definitions/custom-policy-definitions.parameters.example.json --location eastus --management-group-id alz

      - name: Az CLI Deploy Logging
        #if: steps.git_diff.outputs.diff
        uses: Azure/CLI@v1
        with: 
          inlineScript: |
            #!/bin/bash
            az deployment group create --resource-group ${{ env.ResourceGroupName }} --template-file infra-as-code/bicep/modules/logging/logging.bicep --parameters @infra-as-code/bicep/modules/logging/logging.parameters.example.json

      - name: Az CLI Deploy if not Exists
        uses: Azure/CLI@v1
        with: 
          inlineScript: |   
            az deployment mg create --template-file infra-as-code/bicep/modules/policy/assignments/policyAssignmentManagementGroup.bicep --parameters @infra-as-code/bicep/modules/policy/assignments/policyAssignmentManagementGroup.parameters.example-dine.json --location eastus --management-group-id 'alz-landingzones'

      - name: Az CLI built-in Reader role Service Principle
        uses: Azure/CLI@v1
        with: 
          inlineScript: |   
            az deployment mg create --template-file infra-as-code/bicep/modules/roleAssignments/roleAssignmentManagementGroup.bicep --parameters @infra-as-code/bicep/modules/roleAssignments/roleAssignmentManagementGroup.parameters.service-principal.example.json --location eastus --management-group-id 'alz-platform'
      
      - name: Az CLI Subscription Placement
        uses: Azure/CLI@v1
        with: 
          inlineScript: |   
            az deployment mg create --template-file infra-as-code/bicep/modules/subscriptionPlacement/subscriptionPlacement.bicep --parameters @infra-as-code/bicep/modules/subscriptionPlacement/subscriptionPlacement.parameters.example.json --location eastus --management-group-id 'alz'

      - name: Check for hubNetworking Changes
        id: git_diff
        run: |
          git diff infra-as-code/bicep/modules/hubNetworking/hubNetworking.bicep
        #working-directory: ${{ github.repository }}

      - name: Az CLI Deploy hubNetworking
        #if: steps.git_diff.outputs.diff
        uses: Azure/CLI@v1
        with: 
          inlineScript: |
            #!/bin/bash
            az deployment group create --resource-group ${{ env.ResourceGroupName }} --template-file infra-as-code/bicep/modules/hubNetworking/hubNetworking.bicep
      
      - name: Az CLI Remove/Cleanup Deployment
        shell: pwsh
        run: |
            install-module -Name "Az.Accounts" -MinimumVersion "2.5.2" -Force
            install-module -Name "Az.Resources" -MinimumVersion "4.3.0" -Force
            install-module -Name "Az.ResourceGraph" -MinimumVersion "0.7.7"-Force
            .github/scripts/Wipe-ESLZAzTenant.ps1 -tenantRootGroupID "276a2ed9-1969-4990-ba6c-8ac801a64c09" -intermediateRootGroupID "alz"